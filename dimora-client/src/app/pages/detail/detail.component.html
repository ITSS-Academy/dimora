@if(isLoading$ | async) {
<app-loading></app-loading>
} @else { @if(roomData$ | async; as room) { @if(currentUser$ | async; as
currentUser) { @if(room?.id) {
<div class="container">
  <div class="title">{{ room.title }}</div>

  <!-- Gallery -->
  <div class="gallery">
    @for (image of room.images; track $index) {
    <img
      [src]="image"
      [alt]="'Room image ' + ($index + 1)"
      [class]="$index === 0 ? 'main' : ''"
    />
    }
  </div>

  <!-- Wrapper chia 2 cột -->
  <div class="content-wrapper">
    <div class="left-content">
      <!-- Thông tin -->
      <div class="info">
        <p>
          {{ room.max_guests }} khách · {{ room.bedrooms }} phòng ngủ ·
          {{ room.beds }} giường · {{ room.bathrooms }} phòng tắm
        </p>
        <div class="price">Giá đã bao gồm mọi khoản phí</div>
      </div>

      <!-- Host Section -->
      <div class="host-section">
        <div class="host-info">
          <img
            [src]="currentUser.avatar_url"
            alt="Host"
            class="host-avatar"
            referrerpolicy="no-referrer"
          />
          <div>
            <p>
              <strong>Host: {{ currentUser.full_name }}</strong>
            </p>
          </div>
        </div>
      </div>

      <!-- Section hiển thị thêm -->
      <div class="about-section">
        <div class="more-info">
          <h3>Giới thiệu về chỗ ở này</h3>
          <span>
            {{ room.description }}
          </span>
        </div>
      </div>

      <!-- Amenities Section -->
      <div class="amenities-section">
        <h3>Nơi này cung cấp những gì</h3>
        <div class="amenities-grid">
          @for (amenity of room.amenities; track amenity.id) {
          <div class="amenity-item">
            <mat-icon class="material-symbols-rounded">{{
              amenity.icon_name
            }}</mat-icon>
            <span class="amenity-name">{{ amenity.name }}</span>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Booking -->
    <div class="booking-container">
      <form [formGroup]="bookingForm" (ngSubmit)="onBookRoom()">
        <div class="price-section">
          <h2 *ngIf="totalNights > 0 && totalPrice > 0">
            {{ formatPrice(totalPrice) }} VNĐ
          </h2>
          <h2 *ngIf="totalNights === 0 && room.price_per_night">
            {{ formatPrice(room.price_per_night) }} VNĐ
          </h2>
          <p *ngIf="totalNights > 0">cho {{ totalNights }} đêm</p>
          <p *ngIf="totalNights === 0">cho 1 đêm</p>
        </div>
        <div class="date-section">
          <mat-form-field
            appearance="outline"
            class="date-field"
            (click)="picker.open()"
          >
            <mat-date-range-input [rangePicker]="picker" [min]="minDate">
              <input
                matStartDate
                formControlName="start"
                readonly
                placeholder="Ngày bắt đầu"
              />
              <input
                matEndDate
                formControlName="end"
                readonly
                placeholder="Ngày kết thúc"
              />
            </mat-date-range-input>
            <mat-icon class="material-symbols-rounded" matSuffix
              >calendar_month</mat-icon
            >
            <mat-date-range-picker #picker></mat-date-range-picker>
          </mat-form-field>
        </div>

        <div class="guest-section">
          <mat-form-field
            appearance="outline"
            class="guest-field"
            [matMenuTriggerFor]="guestsMenu"
          >
            <mat-label>Khách</mat-label>
            <input
              matInput
              formControlName="guests"
              readonly
              placeholder="Who"
            />
            <mat-icon class="material-symbols-rounded" matSuffix
              >person</mat-icon
            >
          </mat-form-field>

          <mat-menu #guestsMenu="matMenu" class="guests-menu">
            <div class="guests-menu-content">
              <div class="guest-row">
                <div class="guest-info">
                  <div class="guest-label">Adults</div>
                  <div class="guest-subtitle">Ages 13 or above</div>
                </div>
                <div class="guest-controls">
                  <button
                    mat-icon-button
                    (click)="decreaseAdults($event)"
                    [disabled]="adults <= 1"
                  >
                    <mat-icon class="material-symbols-rounded">remove</mat-icon>
                  </button>
                  <span class="guest-count">{{ adults }}</span>
                  <button
                    mat-icon-button
                    (click)="increaseAdults($event)"
                    [disabled]="
                      adults + children + infants >= (room.max_guests || 0)
                    "
                  >
                    <mat-icon class="material-symbols-rounded">add</mat-icon>
                  </button>
                </div>
              </div>

              <div class="guest-row">
                <div class="guest-info">
                  <div class="guest-label">Children</div>
                  <div class="guest-subtitle">Ages 2-12</div>
                </div>
                <div class="guest-controls">
                  <button
                    mat-icon-button
                    (click)="decreaseChildren($event)"
                    [disabled]="children <= 0"
                  >
                    <mat-icon class="material-symbols-rounded">remove</mat-icon>
                  </button>
                  <span class="guest-count">{{ children }}</span>
                  <button
                    mat-icon-button
                    (click)="increaseChildren($event)"
                    [disabled]="
                      adults + children + infants >= (room.max_guests || 0)
                    "
                  >
                    <mat-icon class="material-symbols-rounded">add</mat-icon>
                  </button>
                </div>
              </div>

              <div class="guest-row">
                <div class="guest-info">
                  <div class="guest-label">Infants</div>
                  <div class="guest-subtitle">Under 2</div>
                </div>
                <div class="guest-controls">
                  <button
                    mat-icon-button
                    (click)="decreaseInfants($event)"
                    [disabled]="infants <= 0"
                  >
                    <mat-icon class="material-symbols-rounded">remove</mat-icon>
                  </button>
                  <span class="guest-count">{{ infants }}</span>
                  <button
                    mat-icon-button
                    (click)="increaseInfants($event)"
                    [disabled]="
                      adults + children + infants >= (room.max_guests || 0)
                    "
                  >
                    <mat-icon class="material-symbols-rounded">add</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </mat-menu>
        </div>
        <button mat-flat-button type="submit" class="book-button">
          Đặt phòng
        </button>
      </form>
    </div>
  </div>

  <!-- Modal hiển thị thêm ảnh -->

  <!-- Map Section -->
  <div class="map-section">
    <h3>Vị trí</h3>
    <app-map
      [latitude]="room.latitude"
      [longitude]="room.longitude"
      [zoom]="15"
    >
    </app-map>
  </div>

  <div class="reviews">
    <!-- Review 1 -->
    @for(item of reviewList$ | async; track item.id) {
    <div class="review-item">
      <img
        [src]="item.user_info?.avatar_url"
        alt="avatar"
        class="avatar"
        referrerpolicy="no-referrer"
      />
      <div class="review-content">
        <h4>{{ item.user_info?.full_name }}</h4>
        <span>{{ item.created_at | date : "short" }}</span>

        <div class="text">
          {{ item.comment }}
        </div>
      </div>
    </div>
    }
  </div>
  <!-- Add Comment Section -->
  @if(mineProfile$ | async; as mineProfile) { @if(mineProfile.id) {

  <div class="add-comment">
    <div class="comment-box">
      <img
        [src]="mineProfile.avatar_url"
        alt="avatar"
        class="avatar"
        referrerpolicy="no-referrer"
      />
      <form class="input-area" [formGroup]="profileReview">
        <!-- Rating stars -->
        <!-- Textarea -->
        <mat-form-field appearance="outline" class="comment-textarea">
          <mat-label>Viết đánh giá của bạn...</mat-label>
          <textarea
            type="text"
            matInput
            rows="2"
            style="resize: none; overflow-y: auto"
            formControlName="comment"
          ></textarea>
          <button
            mat-icon-button
            matSuffix
            class="send-btn"
            (click)="onCreateReview()"
          >
            <mat-icon>send</mat-icon>
          </button>
        </mat-form-field>
        <!-- <div class="rating">
            <input type="radio" id="star5" name="rating" value="5">
            <label for="star5" title="5 sao">★</label>
            <input type="radio" id="star4" name="rating" value="4">
            <label for="star4" title="4 sao">★</label>
            <input type="radio" id="star3" name="rating" value="3">
            <label for="star3" title="3 sao">★</label>
            <input type="radio" id="star2" name="rating" value="2">
            <label for="star2" title="2 sao">★</label>
            <input type="radio" id="star1" name="rating" value="1">
            <label for="star1" title="1 sao">★</label>
          </div> -->
      </form>
    </div>
  </div>
  } }
</div>
} @else {
<app-not-found></app-not-found>
} } @else {
<app-not-found></app-not-found>
} } @else {
<app-not-found></app-not-found>
} }
